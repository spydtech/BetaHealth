{% extends "base.html" %}
{% block content %}
<style>
    /* Mobile optimization for chat window height */
    .chat-window {
        height: 500px;
        overflow-y: auto;
        background: #f8f9fa;
    }
    /* On mobile screens, use viewport height to prevent keyboard blocking */
    @media (max-width: 768px) {
        .chat-window {
            height: 60vh; 
        }
    }
</style>

<div class="container mt-4 mb-5">
    <div class="row">
        <div class="col-md-4 mb-3">
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Ticket #{{ ticket.id }}</h5>
                </div>
                <div class="card-body">
                    <p><strong>Status:</strong> 
                        <span class="badge bg-{{ 'success' if ticket.status == 'open' else 'secondary' }}">{{ ticket.status|upper }}</span>
                    </p>
                    <p><strong>Subject:</strong> {{ ticket.subject }}</p>
                    {% if ticket.order_id %}
                        <p><strong>Related Order:</strong> #{{ ticket.order_id }}</p>
                    {% endif %}
                    <p class="text-muted small">Created: {{ ticket.created_at.strftime('%Y-%m-%d %H:%M') }}</p>
                    
                    <a href="{{ url_for('my_tickets') }}" class="btn btn-outline-secondary w-100 mt-3">
                        <i class="fas fa-arrow-left"></i> Back to List
                    </a>
                </div>
            </div>
        </div>

        <div class="col-md-8">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-white">
                    <h5 class="mb-0">Conversation</h5>
                </div>
                
                <div class="card-body chat-window" id="chat-content">
                    {% for msg in messages %}
                        <div class="d-flex mb-3 {{ 'justify-content-end' if msg.sender_role == 'customer' else 'justify-content-start' }}">
                            <div class="card {{ 'bg-primary text-white' if msg.sender_role == 'customer' else 'bg-white text-dark border' }}" style="max-width: 85%;">
                                <div class="card-body p-2">
                                    <small class="d-block mb-1 {{ 'text-light' if msg.sender_role == 'customer' else 'text-muted' }}" style="font-size: 0.75rem;">
                                        {{ 'You' if msg.sender_role == 'customer' else 'Support Agent' }} â€¢ {{ msg.created_at.strftime('%b %d, %H:%M') }}
                                    </small>
                                    <p class="mb-1" style="word-wrap: break-word;">{{ msg.message }}</p>
                                    
                                    {% if msg.images %}
                                        <div class="mt-2">
                                            {% for img in msg.images %}
                                                <a href="{{ url_for('static', filename=img) }}" target="_blank">
                                                    <img src="{{ url_for('static', filename=img) }}" class="img-thumbnail" style="height: 80px; width: auto;">
                                                </a>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>

                {% if ticket.status == 'open' %}
                <div class="card-footer bg-white">
                    <form method="POST" enctype="multipart/form-data">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <div class="mb-2">
                            <textarea name="message" class="form-control" rows="3" required placeholder="Type your reply..."></textarea>
                        </div>
                        
                        <div class="d-flex flex-column flex-md-row justify-content-between align-items-center gap-2">
                            <input type="file" name="images" class="form-control w-100 w-md-auto form-control-sm" multiple accept="image/*">
                            <button type="submit" class="btn btn-primary w-100 w-md-auto"><i class="fas fa-paper-plane"></i> Send Reply</button>
                        </div>
                    </form>
                </div>
                {% else %}
                <div class="card-footer bg-light text-center">
                    <p class="mb-0 text-muted"><i class="fas fa-lock"></i> This ticket is closed.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        var chatBox = document.getElementById("chat-content");

        // Function to scroll to bottom
        function scrollToBottom() {
            if(chatBox) chatBox.scrollTop = chatBox.scrollHeight;
        }

        // Scroll to bottom on initial load
        scrollToBottom();

        // Check for new messages every 5 seconds
        setInterval(function() {
            fetch(window.location.href)
            .then(response => response.text())
            .then(html => {
                var parser = new DOMParser();
                var doc = parser.parseFromString(html, 'text/html');
                
                // CRITICAL: We look for the ID in the NEW HTML
                var newContentElement = doc.getElementById("chat-content");
                
                if (newContentElement) {
                    var newContent = newContentElement.innerHTML;
                    
                    if (chatBox.innerHTML.trim() !== newContent.trim()) {
                        // Check if user is near bottom before refreshing (prevent jumping while reading history)
                        var isAtBottom = chatBox.scrollHeight - chatBox.scrollTop <= chatBox.clientHeight + 100;
                        
                        chatBox.innerHTML = newContent;

                        if (isAtBottom) {
                            scrollToBottom();
                        }
                    }
                }
            })
            .catch(err => console.error("Auto-refresh error:", err));
        }, 5000); // 5000ms = 5 seconds
    });
</script>
{% endblock %}